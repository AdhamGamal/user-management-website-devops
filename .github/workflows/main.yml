name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main  # Trigger on push to the main branch

env:  # ✅ Global environment variables
  DROPLET_IP: '207.154.204.90'

jobs:
#   build_backend:
#     runs-on: ubuntu-latest
#     env:
#       BACKEND_IMAGE: 'adhamgamal22/add-user-backend:1.0'
#     steps:
#       - name: Step 1 - Checkout Code
#         uses: actions/checkout@v4

#       - name: Step 2 - Install Dependencies & Build Backend
#         run: |
#           cd backend
#           npm install
#           echo "✅ Backend setup completed."

#       - name: Step 3 - Build Backend Docker Image
#         run: |
#           docker build -t $BACKEND_IMAGE -f devops/Dockerfile.backend .
#           echo "✅ Backend Docker image built."

#       - name: Step 4 - Push Backend Image to Docker Hub
#         env:
#           DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
#           DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
#         run: |
#           echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
#           docker push $BACKEND_IMAGE
#           echo "✅ Backend image pushed to Docker Hub."

#   build_frontend:
#     runs-on: ubuntu-latest
#     env:
#       FRONTEND_IMAGE: 'adhamgamal22/add-user-frontend:1.0'
#     steps:
#       - name: Step 1 - Checkout Code
#         uses: actions/checkout@v4

#       - name: Step 2 - Install Dependencies & Build Frontend
#         run: |
#           cd frontend
#           npm install
#           npm run build
#           echo "✅ Frontend build completed."

#       - name: Step 3 - Build Frontend Docker Image
#         run: |
#           docker build -t $FRONTEND_IMAGE -f devops/Dockerfile.frontend .
#           echo "✅ Frontend Docker image built."

#       - name: Step 4 - Push Frontend Image to Docker Hub
#         env:
#           DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
#           DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
#         run: |
#           echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
#           docker push $FRONTEND_IMAGE
#           echo "✅ Frontend image pushed to Docker Hub."
        
  deploy:
    # needs: [build_backend, build_frontend]
    runs-on: ubuntu-latest
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          echo "${{ secrets.SSH_PRIVATE_KEY_PASS }}" | ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Run Ansible playbook
        run: |
          ansible-playbook -i devops/inventory.ini devops/deploy.yml
