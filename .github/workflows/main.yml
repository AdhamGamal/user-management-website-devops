name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main  # Trigger on push to the main branch

env:  # ‚úÖ Global environment variables
  DROPLET_IP: '207.154.204.90'

jobs:
  build_backend:
    runs-on: ubuntu-latest
    env:
      BACKEND_IMAGE: 'adhamgamal22/add-user-backend:1.0'
    steps:
      - name: Step 1 - Checkout Code
        uses: actions/checkout@v4

      - name: Step 2 - Install Dependencies & Build Backend
        run: |
          cd backend
          npm install
          echo "‚úÖ Backend setup completed."

      - name: Step 3 - Build Backend Docker Image
        run: |
          docker build -t $BACKEND_IMAGE -f devops/Dockerfile.backend .
          echo "‚úÖ Backend Docker image built."

      - name: Step 4 - Push Backend Image to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push $BACKEND_IMAGE
          echo "‚úÖ Backend image pushed to Docker Hub."

  build_frontend:
    runs-on: ubuntu-latest
    env:
      FRONTEND_IMAGE: 'adhamgamal22/add-user-frontend:1.0'
    steps:
      - name: Step 1 - Checkout Code
        uses: actions/checkout@v4

      - name: Step 2 - Install Dependencies & Build Frontend
        run: |
          cd frontend
          npm install
          npm run build
          echo "‚úÖ Frontend build completed."

      - name: Step 3 - Build Frontend Docker Image
        run: |
          docker build -t $FRONTEND_IMAGE -f devops/Dockerfile.frontend .
          echo "‚úÖ Frontend Docker image built."

      - name: Step 4 - Push Frontend Image to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          docker push $FRONTEND_IMAGE
          echo "‚úÖ Frontend image pushed to Docker Hub."

  setup_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Step 1 - Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible
          echo "‚úÖ Ansible installed."

      - name: Step 2 - Set up SSH key
        env:
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan $DROPLET_IP >> ~/.ssh/known_hosts
          echo "$ANSIBLE_VAULT_PASSWORD" > ~/.ansible_vault_password
          chmod 600 ~/.ansible_vault_password  # Ensure correct permissions
          ls -lah ~  # List files to confirm existence
          echo "‚úÖ Setup SSH key and vault password file."
        
  deploy:
    needs: [build_backend, build_frontend, setup_deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Step 1 - Checkout Code
        uses: actions/checkout@v4

      - name: Step 2 - Deploy to DigitalOcean with Ansible
        run: |
          if [ ! -f ~/.ansible_vault_password ]; then
            echo "‚ùå Vault password file missing! Aborting."
            exit 1
          fi
          echo "üöÄ Running Ansible playbook..."
          ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i devops/inventory.ini devops/deploy.yml --private-key ~/.ssh/id_rsa --vault-password-file ~/.ansible_vault_password
          echo "‚úÖ Deployment completed."
      