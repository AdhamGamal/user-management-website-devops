name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main  # Trigger on push to the main branch

env:  # Global environment variables
  DROPLET_IP: '104.248.40.160'

jobs:
  build_backend:
    runs-on: ubuntu-latest
    env:
      BACKEND_IMAGE: 'adhamgamal22/add-user-backend:1.0'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for Git

      - name: Install Dependencies & Build Backend
        run: |
          echo "ðŸš€ Setting up backend..."
          cd backend
          npm install
          echo "âœ… Backend dependencies installed."

      - name: Build Backend Docker Image
        run: |
          echo "ðŸ³ Building backend Docker image..."
          docker build -t $BACKEND_IMAGE -f devops/Dockerfile.backend .
          echo "âœ… Backend Docker image built."

      - name: Push Backend Image to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "ðŸ” Logging into Docker Hub..."
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          echo "ðŸš€ Pushing backend image to Docker Hub..."
          docker push $BACKEND_IMAGE
          echo "âœ… Backend image pushed to Docker Hub."

  build_frontend:
    runs-on: ubuntu-latest
    env:
      FRONTEND_IMAGE: 'adhamgamal22/add-user-frontend:1.0'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for Git

      - name: Install Dependencies & Build Frontend
        run: |
          echo "ðŸš€ Setting up frontend..."
          cd frontend
          npm install
          npm run build
          echo "âœ… Frontend build completed."

      - name: Build Frontend Docker Image
        run: |
          echo "ðŸ³ Building frontend Docker image..."
          docker build -t $FRONTEND_IMAGE -f devops/Dockerfile.frontend .
          echo "âœ… Frontend Docker image built."

      - name: Push Frontend Image to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "ðŸ” Logging into Docker Hub..."
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          echo "ðŸš€ Pushing frontend image to Docker Hub..."
          docker push $FRONTEND_IMAGE
          echo "âœ… Frontend image pushed to Docker Hub."

  deploy:
    needs: [build_backend, build_frontend]  # Wait for backend and frontend builds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for Git

      - name: Install Ansible
        run: |
          echo "ðŸ“¦ Installing Ansible..."
          sudo apt-get update
          sudo apt-get install -y ansible
          echo "âœ… Ansible installed."

      - name: Run Ansible Playbook
        run: |
          echo "ðŸ”‘ Setting up SSH for deployment..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          echo "${{ secrets.SSH_PRIVATE_KEY_PASS }}" | ssh-add ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY_PASS }}" | ssh-keygen -y -f ~/.ssh/id_rsa > id_rsa.pub
          ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts
          echo "âœ… SSH setup completed."

          echo "ðŸš€ Running Ansible playbook..."
          ansible-playbook -i devops/inventory.ini devops/deploy.yml
          echo "âœ… Deployment completed!"